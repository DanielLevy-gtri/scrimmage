

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Create an OpenAI Plugin &mdash; scrimmage 0.2.0-dev documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Optimizing Parameters in SCRIMMAGE" href="optimize.html" />
    <link rel="prev" title="AirSimSensor Plugin Setup" href="airsim-plugin.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> scrimmage
          

          
          </a>

          
            
            
              <div class="version">
                0.2.0-dev
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../overview/overview.html">Overview</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="tutorials.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="xml-discovery.html">SCRIMMAGE Plugin / XML File Discovery</a></li>
<li class="toctree-l2"><a class="reference internal" href="multiple-local-runs.html">Multiple Runs on a Local Computer</a></li>
<li class="toctree-l2"><a class="reference internal" href="create-project.html">Create a SCRIMMAGE Plugins Project</a></li>
<li class="toctree-l2"><a class="reference internal" href="autonomy-plugin.html">Create an Autonomy Plugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="draw-shapes.html">Draw Shapes in the Viewer</a></li>
<li class="toctree-l2"><a class="reference internal" href="sensor-plugin.html">Create a Sensor Plugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="controller-plugin.html">Create a Controller Plugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="motion-model-plugin.html">Create a Motion Model Plugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="entity-interaction-plugin.html">Create an Entity Interaction Plugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="metrics-plugin.html">Create a Metrics Plugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="parameters.html">Plugin Parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="pub-sub.html">Publishers and Subscribers</a></li>
<li class="toctree-l2"><a class="reference internal" href="gen-entities.html">Generate Entities at Run-Time</a></li>
<li class="toctree-l2"><a class="reference internal" href="scrimmage-ros-integration.html">SCRIMMAGE / ROS Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="ros-plugin.html">Create a ROS Node</a></li>
<li class="toctree-l2"><a class="reference internal" href="airsim-plugin.html">AirSimSensor Plugin Setup</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Create an OpenAI Plugin</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#rewrite-the-autonomy-plugin">Rewrite the Autonomy Plugin</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#openai-autonomy-plugin-header-file">OpenAI Autonomy Plugin Header File</a></li>
<li class="toctree-l4"><a class="reference internal" href="#openai-autonomy-plugin-source-file">OpenAI Autonomy Plugin Source File</a></li>
<li class="toctree-l4"><a class="reference internal" href="#rewrite-cmakelists-txt-for-openai-autonomy">Rewrite CMakeLists.txt for OpenAI Autonomy</a></li>
<li class="toctree-l4"><a class="reference internal" href="#plugin-parameter-file">Plugin Parameter File</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#rewrite-the-sensor-plugin">Rewrite the Sensor Plugin</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#openai-sensor-plugin-header-file">OpenAI Sensor Plugin Header File</a></li>
<li class="toctree-l4"><a class="reference internal" href="#openai-sensor-plugin-source-file">OpenAI Sensor Plugin Source File</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id1">Plugin Parameter File</a></li>
<li class="toctree-l4"><a class="reference internal" href="#rewrite-cmakelists-txt-for-openai-sensor">Rewrite CMakeLists.txt for OpenAI Sensor</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#openai-mission-xml-file">OpenAI Mission XML File</a></li>
<li class="toctree-l3"><a class="reference internal" href="#running-the-openai-environment">Running The OpenAI Environment</a></li>
<li class="toctree-l3"><a class="reference internal" href="#run-in-non-learning-mode-for-non-tensorflow-based-code">Run In Non-learning Mode (for non-Tensorflow-based code)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#run-in-non-learning-mode-using-grpc-for-tensorflow-based-code">Run In Non-learning Mode using gRPC (for Tensorflow-based code)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="optimize.html">Optimizing Parameters in SCRIMMAGE</a></li>
<li class="toctree-l2"><a class="reference internal" href="open-grid.html">Multiple Runs with Open Grid Engine</a></li>
<li class="toctree-l2"><a class="reference internal" href="test.html">Create a SCRIMMAGE Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="utilities.html">Useful Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="simcontrol.html">SimControl API</a></li>
<li class="toctree-l2"><a class="reference internal" href="capture-the-flag.html">Capture the Flag Scenario</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">scrimmage</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="tutorials.html">Tutorials</a> &raquo;</li>
        
      <li>Create an OpenAI Plugin</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/tutorials/openai-plugin.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="create-an-openai-plugin">
<span id="openai-plugin"></span><h1>Create an OpenAI Plugin<a class="headerlink" href="#create-an-openai-plugin" title="Permalink to this headline">Â¶</a></h1>
<p>SCRIMMAGE can be used in conjunction with OpenAI to generate environments for
learning scenarios. OpenAI environments need to have a state space, action
space, and a reward function. In this tutorial, we will go through a quick
example of how to set up a scrimmage agent to interact with OpenAI by providing
a state space, action space, and reward. We will use the plugins project we
created in a previous tutorial (<a class="reference internal" href="create-project.html"><span class="doc">Create a SCRIMMAGE Plugins Project</span></a>) to build our new OpenAI
plugins. To start with, we will need to create an Autonomy and a Sensor plugin.
Files similar to what is described below are located in the following places:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">scrimmage</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">scrimmage</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="n">autonomy</span><span class="o">/</span><span class="n">RLSimple</span>
<span class="n">scrimmage</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="n">autonomy</span><span class="o">/</span><span class="n">RLSimple</span>
<span class="n">scrimmage</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">scrimmage</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="n">sensor</span><span class="o">/</span><span class="n">RLSimpleSensor</span>
<span class="n">scrimmage</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="n">sensor</span><span class="o">/</span><span class="n">RLSimpleSensor</span>
<span class="n">scrimmage</span><span class="o">/</span><span class="n">missions</span><span class="o">/</span><span class="n">rlsimple</span><span class="o">.</span><span class="n">xml</span>
<span class="n">scrimmage</span><span class="o">/</span><span class="n">test</span><span class="o">/</span><span class="n">test_openai</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>In addition, the interface between python and scrimmage is defined in
<code class="docutils literal notranslate"><span class="pre">scrimmage/python/scrimmage/bindings/src/py_openai_env.h</span></code>.
We can use the script provided with SCRIMMAGE to create these plugins (we will
call them something different in this tutorial). To do so,
enter the following at the terminal:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> /path/to/scrimmage/scripts
./generate-plugin.sh autonomy SimpleLearner ~/scrimmage/my-scrimmage-plugins
./generate-plugin.sh sensor MyOpenAISensor ~/scrimmage/my-scrimmage-plugins
</pre></div>
</div>
<p>Now, letâs build the plugins that was placed in the my-scrimmage-plugins
project:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> ~/scrimmage/my-scrimmage-plugins/build
cmake ..
make
<span class="nb">source</span> ~/.scrimmage/setup.bash <span class="c1"># you probably already did this step</span>
</pre></div>
</div>
<p>If the plugin built successfuly, you will see the following output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span> <span class="mi">50</span><span class="o">%</span><span class="p">]</span> <span class="n">Built</span> <span class="n">target</span> <span class="n">MyOpenAISensor_plugin</span>
<span class="p">[</span><span class="mi">100</span><span class="o">%</span><span class="p">]</span> <span class="n">Built</span> <span class="n">target</span> <span class="n">SimpleLearner</span>
</pre></div>
</div>
<p>In general, the SCRIMMAGE openai interface allows you to customize the environment
in the following ways:</p>
<blockquote>
<div><ul class="simple">
<li><p>n agents - The most common scenario is 1 agent but SCRIMMAGE also
supports multi-agent reinforcement learning. In particular, it supports
centralized approaches where actions and observations for individual
learning agents are combined into a single action. Alternatively,
one can have multiple agents operate independently.</p></li>
<li><p>Action/Observation space - this can be discrete, continuous, or combined
(the latter would a <code class="docutils literal notranslate"><span class="pre">TupleSpace</span></code> in openai).</p></li>
</ul>
</div></blockquote>
<p>For a demonstration of these combinations, see <code class="docutils literal notranslate"><span class="pre">test/test_openai.py</span></code>.
For this tutorial, we will only be investigating how to develop a discrete
action space and a continuous observation space.</p>
<div class="section" id="rewrite-the-autonomy-plugin">
<h2>Rewrite the Autonomy Plugin<a class="headerlink" href="#rewrite-the-autonomy-plugin" title="Permalink to this headline">Â¶</a></h2>
<div class="section" id="openai-autonomy-plugin-header-file">
<h3>OpenAI Autonomy Plugin Header File<a class="headerlink" href="#openai-autonomy-plugin-header-file" title="Permalink to this headline">Â¶</a></h3>
<p>In this tutorial, we are going to take the autonomy plugin and rewrite for use
with OpenAI. Letâs start with the header file located at
<code class="docutils literal notranslate"><span class="pre">~/scrimmage/my-scrimmage-plugins/include/my-scrimmage-plugins/plugins/autonomy/SimpleLearner/SimpleLearner.h</span></code>.</p>
<p>Normal autonomy plugins extend the Autonomy class. For the OpenAI autonomy
plugin, we will instead extend the <code class="docutils literal notranslate"><span class="pre">ScrimmageOpenAIAutonomy</span></code> autonomy plugin.
In this case, the <code class="docutils literal notranslate"><span class="pre">init</span></code> and <code class="docutils literal notranslate"><span class="pre">step_autonomy</span></code> functions become <code class="docutils literal notranslate"><span class="pre">init_helper</span></code>
and <code class="docutils literal notranslate"><span class="pre">step_helper</span></code> (the base class will handle the <code class="docutils literal notranslate"><span class="pre">init</span></code> and <code class="docutils literal notranslate"><span class="pre">step_autonomy</span></code>
functions and will call these methods). These methods can be treated similarly
to <code class="docutils literal notranslate"><span class="pre">init</span></code> and <code class="docutils literal notranslate"><span class="pre">step_autonomy</span></code> and exist so that the user can switch
between a learning and non-learning mode seamlessly. In addition,
<code class="docutils literal notranslate"><span class="pre">ScrimmageOpenAIAutonomy</span></code> defines some extra components:</p>
<blockquote>
<div><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">reward_range</span></code> - this setting maps directly to an openai environmentâs
reward_range.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">action_space</span></code> - this is a struct containing a vector of <code class="docutils literal notranslate"><span class="pre">discrete_counts</span></code>
and <code class="docutils literal notranslate"><span class="pre">continuous_extrema</span></code>. For each discrete action you want your autonomy
to have, add an element to <code class="docutils literal notranslate"><span class="pre">action_space.discrete_counts</span></code> with the number
of discrete actions (this will result in a <code class="docutils literal notranslate"><span class="pre">Discrete</span></code> or <code class="docutils literal notranslate"><span class="pre">MultiDiscrete</span></code>
openai space, depending on whether there is one or multiple elements
in <code class="docutils literal notranslate"><span class="pre">action_space.discrete_counts</span></code>). Similarly, if you want continuous actions,
set <code class="docutils literal notranslate"><span class="pre">action_space.continuous_extrema</span></code> with the low and high values
(this will result in a <code class="docutils literal notranslate"><span class="pre">Box</span></code> space). If both <code class="docutils literal notranslate"><span class="pre">discrete_counts</span></code>
and <code class="docutils literal notranslate"><span class="pre">continuous_extrema</span></code> have elements then the resulting space will
be an openai <code class="docutils literal notranslate"><span class="pre">TupleSpace</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">set_environment</span></code> - a virtual method that will be called after
all agents have been generated. This is meant to set <code class="docutils literal notranslate"><span class="pre">reward_range</span></code>
and <code class="docutils literal notranslate"><span class="pre">action_space</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">calc_reward</span></code> - called every timestep, this function returns
a tuple with the following order:</p>
<blockquote>
<div><ul class="simple">
<li><p>done: whether the environment is done</p></li>
<li><p>reward: what the reward for that step is.</p></li>
<li><p>info: a <a class="reference external" href="https://pybind11.readthedocs.io/en/stable">pybind11</a> dict
object that can be used for debugging. Examples of use will be given below.
To return an empty dict (the typical case), just use <code class="docutils literal notranslate"><span class="pre">pybind11::dict()</span></code></p></li>
</ul>
</div></blockquote>
</li>
</ul>
</div></blockquote>
<p>In python, when you call <code class="docutils literal notranslate"><span class="pre">env.step(action)</span></code>, the action will be copied
to your autonomyâs <code class="docutils literal notranslate"><span class="pre">action</span></code> member (defined in <code class="docutils literal notranslate"><span class="pre">ScrimmageOpenAIAutonomy</span></code>.
Here is the include file for <code class="docutils literal notranslate"><span class="pre">SimpleLearner</span></code>:</p>
<div class="highlight-c++ notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#ifndef INCLUDE_MY_SCRIMMAGE_PLUGINS_PLUGINS_AUTONOMY_SIMPLELEARNER_SIMPLELEARNER_H_</span>
<span class="cp">#define INCLUDE_MY_SCRIMMAGE_PLUGINS_PLUGINS_AUTONOMY_SIMPLELEARNER_SIMPLELEARNER_H_</span>

<span class="cp">#include</span> <span class="cpf">&lt;scrimmage/plugins/autonomy/ScrimmageOpenAIAutonomy/ScrimmageOpenAIAutonomy.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;map&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;utility&gt;</span><span class="cp"></span>

<span class="k">class</span> <span class="nc">SimpleLearner</span> <span class="o">:</span> <span class="k">public</span> <span class="n">scrimmage</span><span class="o">::</span><span class="n">autonomy</span><span class="o">::</span><span class="n">ScrimmageOpenAIAutonomy</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
    <span class="kt">void</span> <span class="n">init_helper</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">)</span> <span class="k">override</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="nf">step_helper</span><span class="p">()</span> <span class="k">override</span><span class="p">;</span>

    <span class="kt">void</span> <span class="nf">set_environment</span><span class="p">()</span> <span class="k">override</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">tuple</span><span class="o">&lt;</span><span class="kt">bool</span><span class="p">,</span> <span class="kt">double</span><span class="p">,</span> <span class="n">pybind11</span><span class="o">::</span><span class="n">dict</span><span class="o">&gt;</span> <span class="n">calc_reward</span><span class="p">()</span> <span class="k">override</span><span class="p">;</span>

 <span class="k">protected</span><span class="o">:</span>
    <span class="kt">double</span> <span class="n">radius_</span><span class="p">;</span>
    <span class="kt">uint8_t</span> <span class="n">output_vel_x_idx_</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#endif </span><span class="c1">// INCLUDE_MY_SCRIMMAGE_PLUGINS_PLUGINS_AUTONOMY_SIMPLELEARNER_SIMPLELEARNER_H_</span>
</pre></div>
</td></tr></table></div>
<p>Note that we are overriding four virtual functions: <code class="docutils literal notranslate"><span class="pre">init_helper</span></code>,
<code class="docutils literal notranslate"><span class="pre">step_helper</span></code>, <code class="docutils literal notranslate"><span class="pre">set_environment</span></code>, and <code class="docutils literal notranslate"><span class="pre">calc_reward</span></code>.</p>
</div>
<div class="section" id="openai-autonomy-plugin-source-file">
<h3>OpenAI Autonomy Plugin Source File<a class="headerlink" href="#openai-autonomy-plugin-source-file" title="Permalink to this headline">Â¶</a></h3>
<p>Now letâs open our source file located at
<code class="docutils literal notranslate"><span class="pre">~/scrimmage/my-scrimmage-plugins/src/plugins/autonomy/SimpleLearner/SimpleLearner.cpp</span></code>.</p>
<p>We will first change the includes at the top of the file to be:</p>
<div class="highlight-c++ notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;scrimmage/math/State.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;scrimmage/parse/ParseUtils.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;scrimmage/plugin_manager/RegisterPlugin.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;my-scrimmage-plugins/plugins/autonomy/SimpleLearner/SimpleLearner.h&gt;</span><span class="cp"></span>

<span class="n">REGISTER_PLUGIN</span><span class="p">(</span><span class="n">scrimmage</span><span class="o">::</span><span class="n">Autonomy</span><span class="p">,</span> <span class="n">SimpleLearner</span><span class="p">,</span> <span class="n">SimpleLearner_plugin</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>Next, let us look at the <code class="docutils literal notranslate"><span class="pre">init</span></code>:</p>
<div class="highlight-c++ notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">SimpleLearner</span><span class="o">::</span><span class="n">init_helper</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">using</span> <span class="n">Type</span> <span class="o">=</span> <span class="n">scrimmage</span><span class="o">::</span><span class="n">VariableIO</span><span class="o">::</span><span class="n">Type</span><span class="p">;</span>
    <span class="k">using</span> <span class="n">Dir</span> <span class="o">=</span> <span class="n">scrimmage</span><span class="o">::</span><span class="n">VariableIO</span><span class="o">::</span><span class="n">Direction</span><span class="p">;</span>

    <span class="n">output_vel_x_idx_</span> <span class="o">=</span> <span class="n">vars_</span><span class="p">.</span><span class="n">declare</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">velocity_x</span><span class="p">,</span> <span class="n">Dir</span><span class="o">::</span><span class="n">Out</span><span class="p">);</span>
    <span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">output_vel_y_idx</span> <span class="o">=</span> <span class="n">vars_</span><span class="p">.</span><span class="n">declare</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">velocity_y</span><span class="p">,</span> <span class="n">Dir</span><span class="o">::</span><span class="n">Out</span><span class="p">);</span>
    <span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">output_vel_z_idx</span> <span class="o">=</span> <span class="n">vars_</span><span class="p">.</span><span class="n">declare</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">velocity_z</span><span class="p">,</span> <span class="n">Dir</span><span class="o">::</span><span class="n">Out</span><span class="p">);</span>

    <span class="n">vars_</span><span class="p">.</span><span class="n">output</span><span class="p">(</span><span class="n">output_vel_x_idx_</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">vars_</span><span class="p">.</span><span class="n">output</span><span class="p">(</span><span class="n">output_vel_y_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">vars_</span><span class="p">.</span><span class="n">output</span><span class="p">(</span><span class="n">output_vel_z_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="n">radius_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">stod</span><span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="s">&quot;radius&quot;</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>We now define the environment:</p>
<div class="highlight-c++ notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">SimpleLearner</span><span class="o">::</span><span class="n">set_environment</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">reward_range</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">action_space</span><span class="p">.</span><span class="n">discrete_count</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>This says that the reward range will be between 0 and 1
and we will have a single discrete action that can take values of 0 or 1.
We now define the <code class="docutils literal notranslate"><span class="pre">calc_reward</span></code> function:</p>
<div class="highlight-c++ notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">tuple</span><span class="o">&lt;</span><span class="kt">bool</span><span class="p">,</span> <span class="kt">double</span><span class="p">,</span> <span class="n">pybind11</span><span class="o">::</span><span class="n">dict</span><span class="o">&gt;</span> <span class="n">SimpleLearner</span><span class="o">::</span><span class="n">calc_reward</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">const</span> <span class="kt">bool</span> <span class="n">done</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">double</span> <span class="n">x</span> <span class="o">=</span> <span class="n">state_</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">()(</span><span class="mi">0</span><span class="p">);</span>
    <span class="k">const</span> <span class="kt">bool</span> <span class="n">within_radius</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">round</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">radius_</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">reward</span> <span class="o">=</span> <span class="n">within_radius</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

    <span class="c1">// here we setup the debugging info.</span>
    <span class="n">pybind11</span><span class="o">::</span><span class="n">dict</span> <span class="n">info</span><span class="p">;</span>
    <span class="n">info</span><span class="p">[</span><span class="s">&quot;x_within_radius&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">within_radius</span><span class="p">;</span> <span class="c1">// an example of adding debugging information</span>
    <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">make_tuple</span><span class="p">(</span><span class="n">done</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>This says that the autonomy is never going to end the simulation and gives
a reward for being within the <code class="docutils literal notranslate"><span class="pre">radius</span></code> of the origin. We now define <code class="docutils literal notranslate"><span class="pre">step_helper</span></code>
to handle actions given from python. It will have positive x-velocity
when the action is 1 and negative x-velocity when the action is 0:</p>
<div class="highlight-c++ notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">bool</span> <span class="n">SimpleLearner</span><span class="o">::</span><span class="n">step_helper</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">const</span> <span class="kt">double</span> <span class="n">x_vel</span> <span class="o">=</span> <span class="n">action</span><span class="p">.</span><span class="n">discrete</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">vars_</span><span class="p">.</span><span class="n">output</span><span class="p">(</span><span class="n">output_vel_x_idx_</span><span class="p">,</span> <span class="n">x_vel</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="rewrite-cmakelists-txt-for-openai-autonomy">
<h3>Rewrite CMakeLists.txt for OpenAI Autonomy<a class="headerlink" href="#rewrite-cmakelists-txt-for-openai-autonomy" title="Permalink to this headline">Â¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">SimpleLearner</span></code> C++ code is now finished. Before we can build it though,
we do need to make a small edit to the <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code>. Open up
<code class="docutils literal notranslate"><span class="pre">~/scrimmage/my-scrimmage-plugins/src/plugins/autonomy/SimpleLearner/CMakeLists.txt</span></code>
and change line 15 from</p>
<div class="highlight-cmake notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nb">TARGET_LINK_LIBRARIES</span><span class="p">(</span><span class="o">${</span><span class="nv">LIBRARY_NAME</span><span class="o">}</span>
 <span class="s">scrimmage-core</span>
 <span class="s">ScrimmageOpenAIAutonomy_plugin</span>
  <span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>This makes sure the plugin links to the libraries it needs.</p>
</div>
<div class="section" id="plugin-parameter-file">
<h3>Plugin Parameter File<a class="headerlink" href="#plugin-parameter-file" title="Permalink to this headline">Â¶</a></h3>
<p>The following is the parameter file for <code class="docutils literal notranslate"><span class="pre">SimpleLearner</span></code>:</p>
<div class="highlight-xml notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<span class="cp">&lt;?xml-stylesheet type=&quot;text/xsl&quot; href=&quot;http://gtri.gatech.edu&quot;?&gt;</span>
<span class="nt">&lt;params&gt;</span>
  <span class="nt">&lt;library&gt;</span>SimpleLearner_plugin<span class="nt">&lt;/library&gt;</span>
  <span class="nt">&lt;radius&gt;</span>2<span class="nt">&lt;/radius&gt;</span>
  <span class="nt">&lt;module&gt;</span>my_openai<span class="nt">&lt;/module&gt;</span>
  <span class="nt">&lt;actor_init_func&gt;</span>return_action_func<span class="nt">&lt;/actor_init_func&gt;</span>
<span class="nt">&lt;/params&gt;</span>
</pre></div>
</td></tr></table></div>
<p><code class="docutils literal notranslate"><span class="pre">module</span></code> and <code class="docutils literal notranslate"><span class="pre">actor_init_func</span></code> exist so that we can
call our learner outside the OpenAI environment. This is useful
in case we want to train using python and then do a lot of runs
to test/verify what has been learned.
We will discuss this later in <a class="reference internal" href="#non-learning-mode"><span class="std std-ref">Run In Non-learning Mode (for non-Tensorflow-based code)</span></a>.</p>
<p>From here, we can now build the project:</p>
<div class="highlight-bash notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nb">cd</span> ~/scrimmage/my-scrimmage-plugins/build
cmake ..
make
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="rewrite-the-sensor-plugin">
<h2>Rewrite the Sensor Plugin<a class="headerlink" href="#rewrite-the-sensor-plugin" title="Permalink to this headline">Â¶</a></h2>
<div class="section" id="openai-sensor-plugin-header-file">
<h3>OpenAI Sensor Plugin Header File<a class="headerlink" href="#openai-sensor-plugin-header-file" title="Permalink to this headline">Â¶</a></h3>
<p>The sensor plugin is very similar to the autonomy plugin. It inherits
from <code class="docutils literal notranslate"><span class="pre">ScrimmageOpenAISensor</span></code> which provides
the following:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">observation_space</span></code> - this has the same effect as <code class="docutils literal notranslate"><span class="pre">action_space</span></code> above
but will determine the environmentâs observation space.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">set_observation_space</span></code> - this is similar to <code class="docutils literal notranslate"><span class="pre">set_environment</span></code> above
but is designed to set the variable <code class="docutils literal notranslate"><span class="pre">observation_space</span></code> after all entities
have been generates.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">get_observation</span></code> - there are two versions of this virtual function:
one for discrete observations and another for continuous observations.
Note that because observations can sometimes be high dimensional,
these functions directly edit the underlying python buffers.
This avoids a needless copy.</p></li>
</ul>
</div></blockquote>
<p>Now letâs move on to defining the observation space. We shall do this with through a
sensor plugin to OpenAI. We shall start by rewriting the header file for the
sensor plugin we created above. You can find it at
<code class="docutils literal notranslate"><span class="pre">~/scrimmage/my-scrimmage-plugins/include/my-scrimmage-plugins/plugins/sensor/MyOpenAISensor/MyOpenAISensor.h</span></code>.</p>
<p>First up, we shall rewrite the includes in <code class="docutils literal notranslate"><span class="pre">MyOpenAISensor.h</span></code> to be the
following. The main thing to note is that it inherits from <code class="docutils literal notranslate"><span class="pre">ScrimmageOpenAISensor</span></code>
and overrides two virtual methods:</p>
<div class="highlight-c++ notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#ifndef INCLUDE_MY_SCRIMMAGE_PLUGINS_PLUGINS_SENSOR_MYOPENAISENSOR_MYOPENAISENSOR_H_</span>
<span class="cp">#define INCLUDE_MY_SCRIMMAGE_PLUGINS_PLUGINS_SENSOR_MYOPENAISENSOR_MYOPENAISENSOR_H_</span>

<span class="cp">#include</span> <span class="cpf">&lt;scrimmage/plugins/sensor/ScrimmageOpenAISensor/ScrimmageOpenAISensor.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;map&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;vector&gt;</span><span class="cp"></span>

<span class="k">class</span> <span class="nc">MyOpenAISensor</span> <span class="o">:</span> <span class="k">public</span> <span class="n">scrimmage</span><span class="o">::</span><span class="n">sensor</span><span class="o">::</span><span class="n">ScrimmageOpenAISensor</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
    <span class="kt">void</span> <span class="n">set_observation_space</span><span class="p">()</span> <span class="k">override</span><span class="p">;</span>
    <span class="kt">void</span> <span class="nf">get_observation</span><span class="p">(</span><span class="kt">double</span><span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">beg_idx</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">end_idx</span><span class="p">)</span> <span class="k">override</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#endif </span><span class="c1">// INCLUDE_MY_SCRIMMAGE_PLUGINS_PLUGINS_SENSOR_MYOPENAISENSOR_MYOPENAISENSOR_H_</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="openai-sensor-plugin-source-file">
<h3>OpenAI Sensor Plugin Source File<a class="headerlink" href="#openai-sensor-plugin-source-file" title="Permalink to this headline">Â¶</a></h3>
<p>From here, we can now look at the implementation of these methods in
<code class="docutils literal notranslate"><span class="pre">~/scrimmage/my-scrimmage-plugins/src/plugins/sensor/MyOpenAISensor/MyOpenAISensor.cpp</span></code>.</p>
<p>In this source file, we need to add the following includes:</p>
<div class="highlight-c++ notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;my-scrimmage-plugins/plugins/sensor/MyOpenAISensor/MyOpenAISensor.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;scrimmage/entity/Entity.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;scrimmage/math/State.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;scrimmage/plugin_manager/RegisterPlugin.h&gt;</span><span class="cp"></span>

<span class="n">REGISTER_PLUGIN</span><span class="p">(</span><span class="n">scrimmage</span><span class="o">::</span><span class="n">Sensor</span><span class="p">,</span> <span class="n">MyOpenAISensor</span><span class="p">,</span> <span class="n">MyOpenAISensor_plugin</span><span class="p">)</span>

<span class="kt">void</span> <span class="n">MyOpenAISensor</span><span class="o">::</span><span class="n">get_observation</span><span class="p">(</span><span class="kt">double</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">beg_idx</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="cm">/*end_idx*/</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">data</span><span class="p">[</span><span class="n">beg_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent_</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">()(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">MyOpenAISensor</span><span class="o">::</span><span class="n">set_observation_space</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">const</span> <span class="kt">double</span> <span class="n">inf</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;::</span><span class="n">infinity</span><span class="p">();</span>
    <span class="n">observation_space</span><span class="p">.</span><span class="n">continuous_extrema</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="o">-</span><span class="n">inf</span><span class="p">,</span> <span class="n">inf</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="id1">
<h3>Plugin Parameter File<a class="headerlink" href="#id1" title="Permalink to this headline">Â¶</a></h3>
<div class="highlight-xml notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<span class="cp">&lt;?xml-stylesheet type=&quot;text/xsl&quot; href=&quot;http://gtri.gatech.edu&quot;?&gt;</span>
<span class="nt">&lt;params&gt;</span>
  <span class="nt">&lt;library&gt;</span>MyOpenAISensor_plugin<span class="nt">&lt;/library&gt;</span>
<span class="nt">&lt;/params&gt;</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="rewrite-cmakelists-txt-for-openai-sensor">
<h3>Rewrite CMakeLists.txt for OpenAI Sensor<a class="headerlink" href="#rewrite-cmakelists-txt-for-openai-sensor" title="Permalink to this headline">Â¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">MyOpenAISensor</span></code> C++ code is now finished. Before we can build it though,
we do need to make a small edit to the <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code>. Open up
<code class="docutils literal notranslate"><span class="pre">~/scrimmage/my-scrimmage-plugins/src/plugins/autonomy/SimpleLearner/CMakeLists.txt</span></code>
and change line 15 from</p>
<div class="highlight-cmake notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nb">TARGET_LINK_LIBRARIES</span><span class="p">(</span><span class="o">${</span><span class="nv">LIBRARY_NAME</span><span class="o">}</span>
  <span class="s">scrimmage-core</span>
  <span class="s">ScrimmageOpenAISensor_plugin</span>
<span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="openai-mission-xml-file">
<h2>OpenAI Mission XML File<a class="headerlink" href="#openai-mission-xml-file" title="Permalink to this headline">Â¶</a></h2>
<p>Now that our code for SCRIMMAGE has been compiled, we can then create a simple
mission xml file for it. We will save this xml at:
<code class="docutils literal notranslate"><span class="pre">~/scrimmage/my-scrimmage-plugins/missions/openai_mission.xml</span></code>.</p>
<p>To create the environment as we described above, the mission xml would need the
following blocks (More detail on creating mission files is located at
<a class="reference internal" href="../overview/xml-tags.html#scrimmage-xml"><span class="std std-ref">Mission XML Tag Definitions</span></a> ):</p>
<div class="highlight-xml notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<span class="cp">&lt;?xml-stylesheet type=&quot;text/xsl&quot; href=&quot;http://gtri.gatech.edu&quot;?&gt;</span>
<span class="nt">&lt;runscript</span> <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
    <span class="na">name=</span><span class="s">&quot;Straight flying&quot;</span><span class="nt">&gt;</span>

  <span class="nt">&lt;run</span> <span class="na">start=</span><span class="s">&quot;0.0&quot;</span> <span class="na">end=</span><span class="s">&quot;100&quot;</span> <span class="na">dt=</span><span class="s">&quot;1&quot;</span>
       <span class="na">time_warp=</span><span class="s">&quot;10&quot;</span>
       <span class="na">enable_gui=</span><span class="s">&quot;true&quot;</span>
       <span class="na">network_gui=</span><span class="s">&quot;false&quot;</span>
       <span class="na">start_paused=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>

  <span class="nt">&lt;stream_port&gt;</span>50051<span class="nt">&lt;/stream_port&gt;</span>
  <span class="nt">&lt;stream_ip&gt;</span>localhost<span class="nt">&lt;/stream_ip&gt;</span>

  <span class="nt">&lt;end_condition&gt;</span>time<span class="nt">&lt;/end_condition&gt;</span> <span class="c">&lt;!-- time, one_team, none--&gt;</span>

  <span class="nt">&lt;grid_spacing&gt;</span>1<span class="nt">&lt;/grid_spacing&gt;</span>
  <span class="nt">&lt;grid_size&gt;</span>1000<span class="nt">&lt;/grid_size&gt;</span>

  <span class="nt">&lt;gui_update_period&gt;</span>10<span class="nt">&lt;/gui_update_period&gt;</span> <span class="c">&lt;!-- milliseconds --&gt;</span>

  <span class="nt">&lt;output_type&gt;</span>summary<span class="nt">&lt;/output_type&gt;</span>
  <span class="nt">&lt;metrics&gt;</span>OpenAIRewards<span class="nt">&lt;/metrics&gt;</span>

  <span class="nt">&lt;background_color&gt;</span>191 191 191<span class="nt">&lt;/background_color&gt;</span> <span class="c">&lt;!-- Red Green Blue --&gt;</span>
  <span class="nt">&lt;log_dir&gt;</span>~/.scrimmage/logs<span class="nt">&lt;/log_dir&gt;</span>

  <span class="nt">&lt;entity_common</span> <span class="na">name=</span><span class="s">&quot;all&quot;</span><span class="nt">&gt;</span>
       <span class="nt">&lt;count&gt;</span>1<span class="nt">&lt;/count&gt;</span>
       <span class="nt">&lt;health&gt;</span>1<span class="nt">&lt;/health&gt;</span>
       <span class="nt">&lt;radius&gt;</span>1<span class="nt">&lt;/radius&gt;</span>

       <span class="nt">&lt;team_id&gt;</span>1<span class="nt">&lt;/team_id&gt;</span>
       <span class="nt">&lt;visual_model&gt;</span>Sphere<span class="nt">&lt;/visual_model&gt;</span>
       <span class="nt">&lt;motion_model&gt;</span>SingleIntegrator<span class="nt">&lt;/motion_model&gt;</span>
       <span class="nt">&lt;controller&gt;</span>SingleIntegratorControllerSimple<span class="nt">&lt;/controller&gt;</span>
       <span class="nt">&lt;sensor&gt;</span>MyOpenAISensor<span class="nt">&lt;/sensor&gt;</span>
       <span class="nt">&lt;autonomy&gt;</span>SimpleLearner<span class="nt">&lt;/autonomy&gt;</span>
       <span class="nt">&lt;y&gt;</span>0<span class="nt">&lt;/y&gt;</span>
       <span class="nt">&lt;z&gt;</span>0<span class="nt">&lt;/z&gt;</span>
   <span class="nt">&lt;/entity_common&gt;</span>

   <span class="nt">&lt;entity</span> <span class="na">entity_common=</span><span class="s">&quot;all&quot;</span><span class="nt">&gt;</span>
     <span class="nt">&lt;x&gt;</span>0<span class="nt">&lt;/x&gt;</span>
     <span class="nt">&lt;color&gt;</span>77 77 255<span class="nt">&lt;/color&gt;</span>
   <span class="nt">&lt;/entity&gt;</span>

<span class="nt">&lt;/runscript&gt;</span>
</pre></div>
</td></tr></table></div>
<p>Now we have completed our work on the SCRIMMAGE side. Now all that is left is to
write the python code to run our OpenAI environment.</p>
</div>
<div class="section" id="running-the-openai-environment">
<span id="learning-mode"></span><h2>Running The OpenAI Environment<a class="headerlink" href="#running-the-openai-environment" title="Permalink to this headline">Â¶</a></h2>
<p>The following python code will create a scrimmage environment, using the mission
file we create above. It will then do a simple environment test by stepping
through the environment and keeping track of the observations. It also sends
a straight ahead action for the first 100 timesteps and afterwards sends a turn
right action. At the end, it closes the environment and prints out the total
reward. We will save this python file at
<code class="docutils literal notranslate"><span class="pre">~/scrimmage/my-scrimmage-plugins/my_openai.py</span></code>.</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">gym</span>
<span class="kn">import</span> <span class="nn">scrimmage.utils</span>
<span class="kn">import</span> <span class="nn">random</span>


<span class="k">def</span> <span class="nf">get_action</span><span class="p">(</span><span class="n">obs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># Used for non-learning mode</span>
<span class="k">def</span> <span class="nf">return_action_func</span><span class="p">(</span><span class="n">action_space</span><span class="p">,</span> <span class="n">obs_space</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">get_action</span>

<span class="k">def</span> <span class="nf">test_openai</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">gym</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="s1">&#39;scrimmage-v0&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">gym</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">Error</span><span class="p">:</span>
        <span class="n">mission_file</span> <span class="o">=</span> <span class="n">scrimmage</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">find_mission</span><span class="p">(</span><span class="s1">&#39;openai_mission.xml&#39;</span><span class="p">)</span>

        <span class="n">gym</span><span class="o">.</span><span class="n">envs</span><span class="o">.</span><span class="n">register</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;scrimmage-v0&#39;</span><span class="p">,</span>
            <span class="n">entry_point</span><span class="o">=</span><span class="s1">&#39;scrimmage.bindings:ScrimmageOpenAIEnv&#39;</span><span class="p">,</span>
            <span class="n">max_episode_steps</span><span class="o">=</span><span class="mf">1e9</span><span class="p">,</span>
            <span class="n">reward_threshold</span><span class="o">=</span><span class="mf">1e9</span><span class="p">,</span>
            <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;enable_gui&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s2">&quot;mission_file&quot;</span><span class="p">:</span> <span class="n">mission_file</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">gym</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="s1">&#39;scrimmage-v0&#39;</span><span class="p">)</span>

    <span class="c1"># the observation is the x position of the vehicle</span>
    <span class="c1"># note that a deepcopy is used when a history</span>
    <span class="c1"># of observations is desired. This is because</span>
    <span class="c1"># the sensor plugin edits the data in-place</span>
    <span class="n">obs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">temp_obs</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">())</span>
    <span class="n">obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_obs</span><span class="p">)</span>
    <span class="n">total_reward</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">200</span><span class="p">):</span>

        <span class="n">action</span> <span class="o">=</span> <span class="n">get_action</span><span class="p">(</span><span class="n">temp_obs</span><span class="p">)</span>
        <span class="n">temp_obs</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">action</span><span class="p">)[:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">temp_obs</span><span class="p">))</span>
        <span class="n">total_reward</span> <span class="o">+=</span> <span class="n">reward</span>

        <span class="k">if</span> <span class="n">done</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="n">env</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Total Reward: </span><span class="si">%2.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">total_reward</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">test_openai</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<p>If you havenât done
so already, source the environment setup file. Otherwise it wonât find
the mission below:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">source</span> ~/.scrimmage/setup.bash <span class="c1"># you probably already did this step</span>
</pre></div>
</div>
<p>Now that we have completed all of the code, we can simply type the following
into the terminal to see it run!</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python my_openai.py
</pre></div>
</div>
</div>
<div class="section" id="run-in-non-learning-mode-for-non-tensorflow-based-code">
<span id="non-learning-mode"></span><h2>Run In Non-learning Mode (for non-Tensorflow-based code)<a class="headerlink" href="#run-in-non-learning-mode-for-non-tensorflow-based-code" title="Permalink to this headline">Â¶</a></h2>
<p>In <a class="reference internal" href="#learning-mode"><span class="std std-ref">Running The OpenAI Environment</span></a> we ran an OpenAI environment using
the newly defined environments from SCRIMMAGE. If <cite>my_openai.py</cite>
had done something with the data from the environment,
it may have learned something useful and you may want
to now test/validate what has been learned
using for instance <a class="reference internal" href="multiple-local-runs.html#multiple-local-runs"><span class="std std-ref">Multiple Runs on a Local Computer</span></a>.
In other words, we want to be able to run this line:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ scrimmage missions/openai_mission.xml
</pre></div>
</div>
<p>as well as</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python my_openai.py
</pre></div>
</div>
<p>Because you set the <code class="docutils literal notranslate"><span class="pre">module</span></code> as âmy_openaiâ and <code class="docutils literal notranslate"><span class="pre">actor_init_func</span></code> as
âreturn_action_funcâ in your <code class="docutils literal notranslate"><span class="pre">SimpleLearner.xml</span></code> file, SCRIMMAGE knows where to find
what it needs. <code class="docutils literal notranslate"><span class="pre">actor_init_func</span></code> is a function that will take in the action
space, observation space, and parameters from SCRIMMAGE in order to return a
function that will then be used during non-training mode. This setup is
useful in cases where there is some initialization needed before being able to return actions. For example, there might a directory pointing to some saved
model that needs to be loaded first. By adding a directory parameter to the <code class="docutils literal notranslate"><span class="pre">SimpleLearner.xml</span></code> file, it will then be passed down to the function named in <code class="docutils literal notranslate"><span class="pre">actor_init_func</span></code>. The function returned from <code class="docutils literal notranslate"><span class="pre">actor_init_func</span></code> should take in a
observation and return an action.</p>
<p>To use non-learning mode, <code class="docutils literal notranslate"><span class="pre">nonlearning_mode_openai_plugin</span></code> should be set to true in your mission or
plugin parameter file. Note, if your action method uses tensorflow, you will
need to use <a class="reference internal" href="#non-learning-mode-grpc"><span class="std std-ref">Run In Non-learning Mode using gRPC (for Tensorflow-based code)</span></a>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ scrimmage missions/openai_mission.xml
<span class="o">[</span>&gt;                                                                     <span class="o">]</span> <span class="m">0</span> %
<span class="o">================================================================================</span>
<span class="nv">OpenAIRewards</span>
<span class="o">================================================================================</span>
Reward <span class="k">for</span> id <span class="nv">1</span> <span class="o">=</span> <span class="m">20</span>
Simulation Complete
</pre></div>
</div>
</div>
<div class="section" id="run-in-non-learning-mode-using-grpc-for-tensorflow-based-code">
<span id="non-learning-mode-grpc"></span><h2>Run In Non-learning Mode using gRPC (for Tensorflow-based code)<a class="headerlink" href="#run-in-non-learning-mode-using-grpc-for-tensorflow-based-code" title="Permalink to this headline">Â¶</a></h2>
<p>In <a class="reference internal" href="#non-learning-mode"><span class="std std-ref">Run In Non-learning Mode (for non-Tensorflow-based code)</span></a>, we could start up a trained agent directly inside of SCRIMMAGE. However if your training code uses tensorflow, that method wonât work. What you will need to do instead is use the gRPC mode for non-learning mode. This creates a gRPC server in python that will then run the agent and send the action back across to SCRIMMAGE. To use this mode, <code class="docutils literal notranslate"><span class="pre">module</span></code> and <code class="docutils literal notranslate"><span class="pre">actor_init_func</span></code> will need to be set as before. Then, <code class="docutils literal notranslate"><span class="pre">grpc_mode</span></code> will also need to be set to âtrueâ in <code class="docutils literal notranslate"><span class="pre">SimpleLearner.xml</span></code>. Additional arguments such as <code class="docutils literal notranslate"><span class="pre">grpc_address</span></code> or <code class="docutils literal notranslate"><span class="pre">port</span></code> can also be changed to move what address and port number the gRPC server will located at but the defaults should work fine for most users (localhost on port 50051).</p>
<p>Once the parameters are set, you should be able to run this line:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ scrimmage missions/openai_mission.xml
PYTHON: GRPC Server Started
Connecting to gRPC Server attempt: <span class="m">1</span>/ <span class="nv">10</span>
<span class="o">================================================================================</span>
<span class="nv">OpenAIRewards</span>
<span class="o">================================================================================</span>
Reward <span class="k">for</span> id <span class="nv">1</span> <span class="o">=</span> <span class="m">20</span>
Simulation Complete
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="optimize.html" class="btn btn-neutral float-right" title="Optimizing Parameters in SCRIMMAGE" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="airsim-plugin.html" class="btn btn-neutral float-left" title="AirSimSensor Plugin Setup" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Kevin DeMarco

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>