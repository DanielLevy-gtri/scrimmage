

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Create a Controller Plugin &mdash; scrimmage 0.2.0-dev documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Create a Motion Model Plugin" href="motion-model-plugin.html" />
    <link rel="prev" title="Create a Sensor Plugin" href="sensor-plugin.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> scrimmage
          

          
          </a>

          
            
            
              <div class="version">
                0.2.0-dev
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../overview/overview.html">Overview</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="tutorials.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="xml-discovery.html">Plugin / XML File Discovery</a></li>
<li class="toctree-l2"><a class="reference internal" href="multiple-local-runs.html">Multiple Runs on a Local Computer</a></li>
<li class="toctree-l2"><a class="reference internal" href="create-project.html">Create a SCRIMMAGE Plugins Project</a></li>
<li class="toctree-l2"><a class="reference internal" href="autonomy-plugin.html">Create an Autonomy Plugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="draw-shapes.html">Draw Shapes in the Viewer</a></li>
<li class="toctree-l2"><a class="reference internal" href="sensor-plugin.html">Create a Sensor Plugin</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Create a Controller Plugin</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#examine-controller-plugin">Examine Controller Plugin</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="motion-model-plugin.html">Create a Motion Model Plugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="entity-interaction-plugin.html">Create an Entity Interaction Plugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="metrics-plugin.html">Create a Metrics Plugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="parameters.html">Plugin Parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="pub-sub.html">Publishers and Subscribers</a></li>
<li class="toctree-l2"><a class="reference internal" href="gen-entities.html">Generate Entities at Run-Time</a></li>
<li class="toctree-l2"><a class="reference internal" href="scrimmage-ros-integration.html">SCRIMMAGE / ROS Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="ros-plugin.html">Create a ROS Node</a></li>
<li class="toctree-l2"><a class="reference internal" href="airsim-plugin.html">AirSimSensor Plugin Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="openai-plugin.html">Create an OpenAI Plugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="terrain.html">Create a Digital Terrain Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="optimize.html">Optimizing Parameters in SCRIMMAGE</a></li>
<li class="toctree-l2"><a class="reference internal" href="open-grid.html">Multiple Runs with Open Grid Engine</a></li>
<li class="toctree-l2"><a class="reference internal" href="test.html">Create a SCRIMMAGE Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="utilities.html">Useful Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="simcontrol.html">SimControl API</a></li>
<li class="toctree-l2"><a class="reference internal" href="capture-the-flag.html">Capture the Flag Scenario</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">scrimmage</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="tutorials.html">Tutorials</a> &raquo;</li>
        
      <li>Create a Controller Plugin</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/tutorials/controller-plugin.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="create-a-controller-plugin">
<span id="controller-plugin"></span><h1>Create a Controller Plugin<a class="headerlink" href="#create-a-controller-plugin" title="Permalink to this headline">¶</a></h1>
<p>A Controller plugin converts the <code class="docutils literal notranslate"><span class="pre">desired_state_</span></code> variable and the current
<code class="docutils literal notranslate"><span class="pre">state_</span></code> variable into actuator inputs that drive the motion model’s
dynamics. Currently, there isn’t an automated script to create a Controller
plugin, so if you need to create a controller plugin, you will need to manually
create files and name them appropriately. This will be fixed in the near
future. Currently, Controller plugins are directly associated with Motion Model
plugins, so by convention, Controller plugins are placed in the corresponding
Motion model’s directory. (e.g., <code class="docutils literal notranslate"><span class="pre">SimpleAircraftControllerPID</span></code> is placed
under the <code class="docutils literal notranslate"><span class="pre">motion/SimpleAircraft</span></code> directory).</p>
<div class="section" id="examine-controller-plugin">
<h2>Examine Controller Plugin<a class="headerlink" href="#examine-controller-plugin" title="Permalink to this headline">¶</a></h2>
<p>Let’s take a look at the SimpleAircraftControllerPID Controller plugin. The
SimpleAircraftControllerPID controls the thrust, roll, pitch, and yaw of the
SimpleAircraft in order to reach the desired speed, altitude, and heading set
by the Autonomy plugin. The SimpleAircraftControllerPID plugin makes use of
SCRIMMAGE’s built-in PID controller. The <code class="docutils literal notranslate"><span class="pre">init</span></code> function sets the PID gains
with the help of a helper function, <code class="docutils literal notranslate"><span class="pre">set_pid</span></code>:</p>
<div class="highlight-c++ notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">set_pid</span><span class="p">(</span><span class="n">sc</span><span class="o">::</span><span class="n">PID</span> <span class="o">&amp;</span><span class="n">pid</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">str</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">is_angle</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">str_vals</span><span class="p">;</span>
    <span class="n">boost</span><span class="o">::</span><span class="n">split</span><span class="p">(</span><span class="n">str_vals</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">boost</span><span class="o">::</span><span class="n">is_any_of</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">str_vals</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;error parsing in SimpleAircraftControllerPID&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="kt">double</span> <span class="n">p</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">stod</span><span class="p">(</span><span class="n">str_vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="kt">double</span> <span class="n">i</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">stod</span><span class="p">(</span><span class="n">str_vals</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
        <span class="kt">double</span> <span class="n">d</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">stod</span><span class="p">(</span><span class="n">str_vals</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
        <span class="n">pid</span><span class="p">.</span><span class="n">set_parameters</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">is_angle</span><span class="p">)</span> <span class="p">{</span>
            <span class="kt">double</span> <span class="n">i_lim</span> <span class="o">=</span> <span class="n">sc</span><span class="o">::</span><span class="n">Angles</span><span class="o">::</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">stod</span><span class="p">(</span><span class="n">str_vals</span><span class="p">[</span><span class="mi">3</span><span class="p">]));</span>
            <span class="n">pid</span><span class="p">.</span><span class="n">set_integral_band</span><span class="p">(</span><span class="n">i_lim</span><span class="p">);</span>
            <span class="n">pid</span><span class="p">.</span><span class="n">set_is_angle</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="kt">double</span> <span class="n">i_lim</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">stod</span><span class="p">(</span><span class="n">str_vals</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
            <span class="n">pid</span><span class="p">.</span><span class="n">set_integral_band</span><span class="p">(</span><span class="n">i_lim</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">SimpleAircraftControllerPID</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">set_pid</span><span class="p">(</span><span class="n">heading_pid_</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s">&quot;heading_pid&quot;</span><span class="p">],</span> <span class="nb">true</span><span class="p">);</span>
    <span class="n">set_pid</span><span class="p">(</span><span class="n">alt_pid_</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s">&quot;alt_pid&quot;</span><span class="p">],</span> <span class="nb">false</span><span class="p">);</span>
    <span class="n">set_pid</span><span class="p">(</span><span class="n">vel_pid_</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s">&quot;vel_pid&quot;</span><span class="p">],</span> <span class="nb">false</span><span class="p">);</span>
    <span class="n">u_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span><span class="o">&gt;</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>The plugin’s XML file contains the actual PID gain values:</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;params&gt;</span>

...

<span class="nt">&lt;heading_pid&gt;</span>0.2, 0.01, 0.001, 9<span class="nt">&lt;/heading_pid&gt;</span>
<span class="nt">&lt;alt_pid&gt;</span>0.0025, 0.0001, 0.0002, 1<span class="nt">&lt;/alt_pid&gt;</span>
<span class="nt">&lt;vel_pid&gt;</span>1, 0.1, 0, 1<span class="nt">&lt;/vel_pid&gt;</span>

...

<span class="nt">&lt;/params&gt;</span>
</pre></div>
</div>
<p>The Controller’s <code class="docutils literal notranslate"><span class="pre">step</span></code> method merely assigns the new setpoints coming from
the Autonomy plugin to each PID controller, tells each PID the current value of
the state variable being tracked, and tells each PID to update itself. The PID
output values are assigned to the <code class="docutils literal notranslate"><span class="pre">vars_</span></code> variable available to all SCRIMMAGE
plugins, which is retrieved later by the Motion Model plugin when it runs.</p>
<div class="highlight-c++ notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">bool</span> <span class="n">SimpleAircraftControllerPID</span><span class="o">::</span><span class="n">step</span><span class="p">(</span><span class="kt">double</span> <span class="n">t</span><span class="p">,</span> <span class="kt">double</span> <span class="n">dt</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">heading_pid_</span><span class="p">.</span><span class="n">set_setpoint</span><span class="p">(</span><span class="n">vars_</span><span class="p">.</span><span class="n">input</span><span class="p">(</span><span class="n">input_roll_or_heading_idx_</span><span class="p">));</span>
    <span class="kt">double</span> <span class="n">u_roll_rate</span> <span class="o">=</span> <span class="n">use_roll_</span> <span class="o">?</span>
        <span class="o">-</span><span class="n">heading_pid_</span><span class="p">.</span><span class="n">step</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">state_</span><span class="o">-&gt;</span><span class="n">quat</span><span class="p">().</span><span class="n">roll</span><span class="p">())</span> <span class="o">:</span>
        <span class="n">heading_pid_</span><span class="p">.</span><span class="n">step</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">state_</span><span class="o">-&gt;</span><span class="n">quat</span><span class="p">().</span><span class="n">yaw</span><span class="p">());</span>

    <span class="n">alt_pid_</span><span class="p">.</span><span class="n">set_setpoint</span><span class="p">(</span><span class="n">vars_</span><span class="p">.</span><span class="n">input</span><span class="p">(</span><span class="n">input_altitude_idx_</span><span class="p">));</span>
    <span class="kt">double</span> <span class="n">u_pitch_rate</span> <span class="o">=</span> <span class="o">-</span><span class="n">alt_pid_</span><span class="p">.</span><span class="n">step</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">state_</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">()(</span><span class="mi">2</span><span class="p">));</span>

    <span class="n">vel_pid_</span><span class="p">.</span><span class="n">set_setpoint</span><span class="p">(</span><span class="n">vars_</span><span class="p">.</span><span class="n">input</span><span class="p">(</span><span class="n">input_velocity_idx_</span><span class="p">));</span>
    <span class="kt">double</span> <span class="n">u_throttle</span> <span class="o">=</span> <span class="n">vel_pid_</span><span class="p">.</span><span class="n">step</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">state_</span><span class="o">-&gt;</span><span class="n">vel</span><span class="p">().</span><span class="n">norm</span><span class="p">());</span>

    <span class="n">vars_</span><span class="p">.</span><span class="n">output</span><span class="p">(</span><span class="n">output_roll_rate_idx_</span><span class="p">,</span> <span class="n">u_roll_rate</span><span class="p">);</span>
    <span class="n">vars_</span><span class="p">.</span><span class="n">output</span><span class="p">(</span><span class="n">output_pitch_rate_idx_</span><span class="p">,</span> <span class="n">u_pitch_rate</span><span class="p">);</span>
    <span class="n">vars_</span><span class="p">.</span><span class="n">output</span><span class="p">(</span><span class="n">output_throttle_idx_</span><span class="p">,</span> <span class="n">u_throttle</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="motion-model-plugin.html" class="btn btn-neutral float-right" title="Create a Motion Model Plugin" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="sensor-plugin.html" class="btn btn-neutral float-left" title="Create a Sensor Plugin" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Kevin DeMarco

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>